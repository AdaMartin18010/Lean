# 5.5 调试工具 / Debugging Tools

[返回目录](README.md) | [上一节](5.4-包管理.md) | [下一节](5.6-测试工具.md)

---

## 概述 / Overview

调试工具是Lean语言开发过程中不可或缺的组成部分，为开发者提供断点调试、变量查看、调用栈跟踪、性能分析等功能。本章详细介绍Lean 4的调试工具、配置方法、使用技巧等，帮助开发者高效地诊断和解决问题。

## 1. 调试器基础 / Debugger Basics

### 1.1 调试器配置 / Debugger Configuration

**定义 1.1.1** (调试器) Lean 4内置调试器：

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Debug Lean 4",
      "type": "lean4",
      "request": "launch",
      "program": "${workspaceFolder}/Main.lean",
      "args": [],
      "cwd": "${workspaceFolder}",
      "env": {},
      "console": "integratedTerminal",
      "stopOnEntry": false,
      "showReturnValue": true,
      "justMyCode": true
    }
  ]
}
```

**配置 1.1.1** (调试配置) 调试器配置选项：

```json
{
  "debugger": {
    "enabled": true,
    "port": 5678,
    "host": "localhost",
    "timeout": 30,
    "breakpoints": {
      "enabled": true,
      "conditional": true,
      "logpoints": true
    },
    "stepping": {
      "stepInto": true,
      "stepOver": true,
      "stepOut": true,
      "continue": true
    }
  }
}
```

### 1.2 断点设置 / Breakpoint Setting

**定义 1.2.1** (断点) 断点设置和配置：

```lean
-- 断点示例
def debug_example (x : Nat) : Nat :=
  let y := x + 1
  -- 在这里设置断点
  let z := y * 2
  -- 在这里设置条件断点 (z > 10)
  z + 1
```

**配置 1.2.1** (断点配置) 断点配置选项：

```json
{
  "breakpoints": [
    {
      "file": "Main.lean",
      "line": 5,
      "column": 1,
      "condition": "",
      "hitCount": 0,
      "logMessage": ""
    },
    {
      "file": "Main.lean",
      "line": 8,
      "column": 1,
      "condition": "z > 10",
      "hitCount": 3,
      "logMessage": "z is greater than 10"
    }
  ]
}
```

## 2. 变量查看 / Variable Inspection

### 2.1 变量监视 / Variable Watching

**定义 2.1.1** (变量监视) 变量监视和查看：

```lean
-- 变量监视示例
def variable_watch_example (x : Nat) : Nat :=
  let y := x + 1
  -- 监视变量 y
  let z := y * 2
  -- 监视变量 z
  let result := z + 1
  -- 监视变量 result
  result
```

**配置 2.1.1** (监视配置) 变量监视配置：

```json
{
  "watch": [
    {
      "name": "x",
      "type": "Nat",
      "value": "5",
      "scope": "local"
    },
    {
      "name": "y",
      "type": "Nat",
      "value": "6",
      "scope": "local"
    },
    {
      "name": "z",
      "type": "Nat",
      "value": "12",
      "scope": "local"
    }
  ]
}
```

### 2.2 表达式求值 / Expression Evaluation

**定义 2.2.1** (表达式求值) 调试时的表达式求值：

```lean
-- 表达式求值示例
def expression_evaluation_example (x : Nat) : Nat :=
  let y := x + 1
  -- 在调试器中求值: x + y
  -- 在调试器中求值: y * 2
  let z := y * 2
  -- 在调试器中求值: z > 10
  if z > 10 then z else y
```

**配置 2.2.1** (求值配置) 表达式求值配置：

```json
{
  "evaluation": {
    "enabled": true,
    "timeout": 5,
    "maxDepth": 10,
    "maxLength": 1000,
    "allowedFunctions": [
      "Nat.add",
      "Nat.mul",
      "Nat.sub"
    ]
  }
}
```

## 3. 调用栈跟踪 / Call Stack Tracing

### 3.1 调用栈查看 / Call Stack Inspection

**定义 3.1.1** (调用栈) 函数调用栈跟踪：

```lean
-- 调用栈示例
def function_a (x : Nat) : Nat :=
  function_b (x + 1)

def function_b (y : Nat) : Nat :=
  function_c (y * 2)

def function_c (z : Nat) : Nat :=
  -- 在这里查看调用栈
  z + 1

-- 调用链: function_a -> function_b -> function_c
```

**配置 3.1.1** (调用栈配置) 调用栈配置选项：

```json
{
  "callStack": {
    "enabled": true,
    "maxDepth": 100,
    "showArguments": true,
    "showReturnValues": true,
    "showLocalVariables": true,
    "showGlobalVariables": false
  }
}
```

### 3.2 堆栈帧 / Stack Frames

**定义 3.2.1** (堆栈帧) 堆栈帧信息：

```json
{
  "stackFrames": [
    {
      "id": 1,
      "name": "function_c",
      "source": {
        "name": "Main.lean",
        "path": "/path/to/Main.lean",
        "line": 8,
        "column": 1
      },
      "arguments": [
        {
          "name": "z",
          "type": "Nat",
          "value": "12"
        }
      ],
      "localVariables": [
        {
          "name": "z",
          "type": "Nat",
          "value": "12"
        }
      ]
    },
    {
      "id": 2,
      "name": "function_b",
      "source": {
        "name": "Main.lean",
        "path": "/path/to/Main.lean",
        "line": 5,
        "column": 1
      },
      "arguments": [
        {
          "name": "y",
          "type": "Nat",
          "value": "6"
        }
      ],
      "localVariables": [
        {
          "name": "y",
          "type": "Nat",
          "value": "6"
        }
      ]
    }
  ]
}
```

## 4. 性能分析 / Performance Profiling

### 4.1 性能分析器 / Performance Profiler

**定义 4.1.1** (性能分析) 性能分析配置：

```bash
# 性能分析命令
lean --profile Main.lean

# 时间分析
lean --time-profile Main.lean

# 内存分析
lean --memory-profile Main.lean

# 调用图分析
lean --call-graph Main.lean
```

**配置 4.1.1** (分析配置) 性能分析配置：

```json
{
  "profiling": {
    "enabled": true,
    "type": "time",
    "output": "profile.json",
    "format": "json",
    "options": {
      "includeSystemCalls": false,
      "includeMemoryAllocations": true,
      "includeGarbageCollection": true,
      "sampleRate": 1000
    }
  }
}
```

### 4.2 性能报告 / Performance Reports

**定义 4.2.1** (性能报告) 性能分析报告：

```json
{
  "profile": {
    "totalTime": 1.234,
    "functions": [
      {
        "name": "function_a",
        "time": 0.123,
        "percentage": 10.0,
        "calls": 1,
        "averageTime": 0.123
      },
      {
        "name": "function_b",
        "time": 0.456,
        "percentage": 37.0,
        "calls": 1,
        "averageTime": 0.456
      },
      {
        "name": "function_c",
        "time": 0.655,
        "percentage": 53.0,
        "calls": 1,
        "averageTime": 0.655
      }
    ],
    "memory": {
      "totalAllocated": 1024,
      "peakUsage": 512,
      "garbageCollections": 3
    }
  }
}
```

## 5. 内存调试 / Memory Debugging

### 5.1 内存泄漏检测 / Memory Leak Detection

**定义 5.1.1** (内存调试) 内存泄漏检测：

```bash
# 内存调试
lean --memory-debug Main.lean

# 内存泄漏检测
lean --leak-check Main.lean

# 内存使用分析
lean --memory-usage Main.lean

# 垃圾回收分析
lean --gc-analysis Main.lean
```

**配置 5.1.1** (内存配置) 内存调试配置：

```json
{
  "memory": {
    "debug": true,
    "leakCheck": true,
    "usageAnalysis": true,
    "gcAnalysis": true,
    "options": {
      "trackAllocations": true,
      "trackDeallocations": true,
      "trackReferences": true,
      "maxAllocations": 1000000
    }
  }
}
```

### 5.2 内存使用报告 / Memory Usage Reports

**定义 5.2.1** (内存报告) 内存使用报告：

```json
{
  "memoryReport": {
    "totalAllocated": 2048,
    "currentUsage": 1024,
    "peakUsage": 1536,
    "allocations": [
      {
        "function": "function_a",
        "size": 64,
        "count": 1,
        "location": "Main.lean:3"
      },
      {
        "function": "function_b",
        "size": 128,
        "count": 1,
        "location": "Main.lean:6"
      }
    ],
    "leaks": [
      {
        "size": 32,
        "location": "Main.lean:9",
        "function": "function_c"
      }
    ]
  }
}
```

## 6. 并发调试 / Concurrency Debugging

### 6.1 线程调试 / Thread Debugging

**定义 6.1.1** (线程调试) 多线程程序调试：

```lean
-- 并发调试示例
def concurrent_example : IO Unit := do
  let t1 ← IO.asTask (IO.sleep 1000)
  let t2 ← IO.asTask (IO.sleep 2000)
  -- 在这里调试线程状态
  let result1 ← t1.get
  let result2 ← t2.get
  IO.println "Both tasks completed"
```

**配置 6.1.1** (线程配置) 线程调试配置：

```json
{
  "threading": {
    "debug": true,
    "showThreads": true,
    "showLocks": true,
    "showDeadlocks": true,
    "options": {
      "maxThreads": 100,
      "trackLocks": true,
      "trackWaitStates": true
    }
  }
}
```

### 6.2 死锁检测 / Deadlock Detection

**定义 6.2.1** (死锁检测) 死锁检测和预防：

```json
{
  "deadlockDetection": {
    "enabled": true,
    "timeout": 30,
    "algorithms": [
      "cycle-detection",
      "resource-allocation-graph"
    ],
    "prevention": {
      "enabled": true,
      "strategy": "timeout"
    }
  }
}
```

## 7. 远程调试 / Remote Debugging

### 7.1 远程调试配置 / Remote Debugging Configuration

**定义 7.1.1** (远程调试) 远程调试配置：

```json
{
  "remoteDebugging": {
    "enabled": true,
    "host": "192.168.1.100",
    "port": 5678,
    "protocol": "tcp",
    "authentication": {
      "type": "token",
      "token": "debug-token-123"
    },
    "options": {
      "timeout": 30,
      "retryCount": 3,
      "keepAlive": true
    }
  }
}
```

### 7.2 远程调试连接 / Remote Debugging Connection

**定义 7.2.1** (远程连接) 远程调试连接：

```bash
# 启动远程调试服务器
lean --remote-debug --port=5678 Main.lean

# 连接到远程调试器
lean-debugger --connect 192.168.1.100:5678

# 远程调试命令
lean-debugger --remote --host=192.168.1.100 --port=5678
```

## 8. 调试脚本 / Debugging Scripts

### 8.1 自动化调试 / Automated Debugging

**定义 8.1.1** (调试脚本) 自动化调试脚本：

```python
# 调试脚本示例
import lean_debugger

def automated_debugging():
    # 连接到调试器
    debugger = lean_debugger.connect("localhost:5678")
    
    # 设置断点
    debugger.set_breakpoint("Main.lean", 5)
    
    # 运行程序
    debugger.run()
    
    # 检查变量
    variables = debugger.get_variables()
    print(f"Variables: {variables}")
    
    # 继续执行
    debugger.continue()
    
    # 获取结果
    result = debugger.get_result()
    print(f"Result: {result}")
```

### 8.2 调试测试 / Debugging Tests

**定义 8.2.1** (调试测试) 调试测试脚本：

```lean
-- 调试测试示例
def debug_test : IO Unit := do
  let x := 5
  let y := x + 1
  -- 测试断点
  let z := y * 2
  -- 测试变量监视
  if z > 10 then
    IO.println "z is greater than 10"
  else
    IO.println "z is not greater than 10"
```

## 9. 调试最佳实践 / Debugging Best Practices

### 9.1 调试策略 / Debugging Strategies

**实践 9.1.1** (调试策略) 调试策略和技巧：

1. **系统化调试**：按步骤系统化地调试问题
2. **假设验证**：通过断点和变量监视验证假设
3. **最小化复现**：创建最小化的复现案例
4. **日志记录**：使用日志记录关键信息

### 9.2 性能调试 / Performance Debugging

**实践 9.2.1** (性能调试) 性能调试最佳实践：

1. **性能分析**：使用性能分析器识别瓶颈
2. **内存监控**：监控内存使用和泄漏
3. **算法优化**：优化算法复杂度
4. **资源管理**：合理管理系统资源

## 10. 故障排除 / Troubleshooting

### 10.1 调试器问题 / Debugger Issues

**问题 10.1.1** (调试器问题) 调试器常见问题：

```bash
# 调试器无法启动
lean --debug --verbose Main.lean

# 断点不生效
lean --debug --breakpoint-verify Main.lean

# 变量无法查看
lean --debug --variable-inspection Main.lean
```

**解决方案 10.1.1** (问题解决) 调试器问题解决方案：

1. **连接问题**：检查调试器连接
2. **权限问题**：检查文件权限
3. **版本问题**：确保版本兼容
4. **配置问题**：验证配置文件

### 10.2 性能问题 / Performance Issues

**问题 10.2.1** (性能问题) 性能调试问题：

```bash
# 性能分析失败
lean --profile --verbose Main.lean

# 内存分析问题
lean --memory-profile --debug Main.lean

# 调用图生成失败
lean --call-graph --verbose Main.lean
```

## 11. 总结与展望 / Summary and Outlook

### 11.1 核心贡献 / Core Contributions

1. **完整调试**：提供了完整的调试工具集
2. **性能分析**：建立了性能分析和优化体系
3. **内存管理**：提供了内存调试和泄漏检测
4. **并发支持**：支持多线程和并发调试

### 11.2 未来方向 / Future Directions

1. **功能扩展**：继续扩展调试功能
2. **性能优化**：进一步优化调试性能
3. **可视化改进**：改善调试界面和可视化
4. **自动化增强**：增强自动化调试能力

---

## 交叉引用 / Cross-References

- **上一节**：[5.4 包管理](5.4-包管理.md)
- **下一节**：[5.6 测试工具](5.6-测试工具.md)
- **上位主题**：[5. 工具集成指南](README.md)
- **下位细分主题**：
  - [5.5.1 调试器基础详解](5.5.1-调试器基础详解.md)
  - [5.5.2 性能分析详解](5.5.2-性能分析详解.md)
  - [5.5.3 内存调试详解](5.5.3-内存调试详解.md)

## 参考资料 / References

1. **官方文档**：
   - [Lean 4 调试器文档](https://leanprover.github.io/lean4/doc/)
   - [VS Code 调试配置](https://code.visualstudio.com/docs/editor/debugging)

2. **技术文档**：
   - [GDB 调试器](https://www.gnu.org/software/gdb/)
   - [Valgrind 内存调试](https://valgrind.org/)

3. **社区资源**：
   - [Lean 社区论坛](https://leanprover-community.github.io/)
   - [调试技巧分享](https://leanprover-community.github.io/learn.html)

---

## 变更记录 / Change Log

### v2025-01-01

- 初始版本创建
- 添加调试器基础配置和断点设置
- 建立变量查看和调用栈跟踪
- 添加性能分析和内存调试
- 建立故障排除和最佳实践指南

---

*最后更新：2025-01-01*  
*版本：v2025-01*  
*状态：已完成 ✅*
