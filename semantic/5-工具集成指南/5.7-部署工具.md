# 5.7 部署工具 / Deployment Tools

[返回目录](README.md) | [上一节](5.6-测试工具.md) | [返回目录](README.md)

---

## 概述 / Overview

部署工具是Lean语言项目从开发到生产的关键环节，为开发者提供应用部署、容器化、CI/CD集成、环境管理等功能。本章详细介绍Lean 4的部署工具、配置方法、最佳实践等，帮助开发者实现高效的应用部署。

## 1. 部署基础 / Deployment Basics

### 1.1 部署配置 / Deployment Configuration

**定义 1.1.1** (部署配置) Lean 4应用部署配置：

```json
{
  "deployment": {
    "name": "my-lean-app",
    "version": "1.0.0",
    "environment": "production",
    "target": {
      "platform": "linux",
      "architecture": "x86_64",
      "os": "ubuntu-20.04"
    },
    "resources": {
      "cpu": "2",
      "memory": "4Gi",
      "storage": "10Gi"
    }
  }
}
```

**配置 1.1.1** (部署选项) 部署配置选项：

```json
{
  "deployment": {
    "strategy": "rolling",
    "replicas": 3,
    "healthCheck": {
      "enabled": true,
      "path": "/health",
      "interval": 30,
      "timeout": 10
    },
    "scaling": {
      "minReplicas": 1,
      "maxReplicas": 10,
      "targetCPU": 70
    }
  }
}
```

### 1.2 构建配置 / Build Configuration

**定义 1.2.1** (构建配置) 生产构建配置：

```lean
-- lakefile.lean 生产构建配置
import Lake
open Lake DSL

-- 生产构建目标
target «production-build» : FilePath := do
  let src ← inputFile "Main.lean"
  let exe ← buildExe "my-app" src
  -- 优化构建
  let optimized ← optimizeExe exe
  return optimized

-- 优化配置
def optimizeExe (exe : FilePath) : IO FilePath := do
  -- 应用生产优化
  let optimized := exe.withExtension "optimized"
  -- 执行优化命令
  IO.Process.run {
    cmd := "lean",
    args := ["--optimize", exe.toString, "-o", optimized.toString]
  }
  return optimized
```

## 2. 容器化部署 / Containerized Deployment

### 2.1 Docker配置 / Docker Configuration

**定义 2.1.1** (Dockerfile) Lean 4应用Dockerfile：

```dockerfile
# Dockerfile
FROM leanprover/lean4:latest

# 设置工作目录
WORKDIR /app

# 复制项目文件
COPY lakefile.lean .
COPY MyProject.lean .
COPY MyProject/ ./MyProject/

# 安装依赖
RUN lake update

# 构建应用
RUN lake build

# 设置环境变量
ENV LEAN_PATH=/app
ENV LAKE_PATH=/app

# 暴露端口
EXPOSE 8080

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:8080/health || exit 1

# 启动命令
CMD ["lake", "run", "MyProject"]
```

**配置 2.1.1** (Docker配置) Docker配置选项：

```json
{
  "docker": {
    "baseImage": "leanprover/lean4:latest",
    "workdir": "/app",
    "expose": [8080],
    "environment": {
      "LEAN_PATH": "/app",
      "LAKE_PATH": "/app"
    },
    "healthCheck": {
      "interval": "30s",
      "timeout": "10s",
      "retries": 3,
      "command": "curl -f http://localhost:8080/health"
    }
  }
}
```

### 2.2 多阶段构建 / Multi-stage Build

**定义 2.2.1** (多阶段Dockerfile) 多阶段构建配置：

```dockerfile
# 多阶段构建 Dockerfile
# 构建阶段
FROM leanprover/lean4:latest AS builder

WORKDIR /app
COPY lakefile.lean .
COPY MyProject.lean .
COPY MyProject/ ./MyProject/

RUN lake update
RUN lake build

# 运行阶段
FROM ubuntu:20.04 AS runtime

# 安装运行时依赖
RUN apt-get update && apt-get install -y \
    libgmp-dev \
    libffi-dev \
    && rm -rf /var/lib/apt/lists/*

# 复制构建产物
COPY --from=builder /app/build/MyProject /usr/local/bin/my-app

# 设置权限
RUN chmod +x /usr/local/bin/my-app

# 创建非root用户
RUN useradd -m -u 1000 appuser
USER appuser

# 暴露端口
EXPOSE 8080

# 启动应用
CMD ["/usr/local/bin/my-app"]
```

## 3. Kubernetes部署 / Kubernetes Deployment

### 3.1 Kubernetes配置 / Kubernetes Configuration

**定义 3.1.1** (Kubernetes部署) Kubernetes部署配置：

```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-lean-app
  labels:
    app: my-lean-app
spec:
  replicas: 3
  selector:
    matchLabels:
      app: my-lean-app
  template:
    metadata:
      labels:
        app: my-lean-app
    spec:
      containers:
      - name: my-lean-app
        image: my-lean-app:latest
        ports:
        - containerPort: 8080
        env:
        - name: LEAN_PATH
          value: "/app"
        - name: LAKE_PATH
          value: "/app"
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
```

**配置 3.1.1** (K8s配置) Kubernetes配置选项：

```json
{
  "kubernetes": {
    "deployment": {
      "replicas": 3,
      "strategy": "RollingUpdate",
      "maxUnavailable": 1,
      "maxSurge": 1
    },
    "service": {
      "type": "ClusterIP",
      "ports": [8080]
    },
    "ingress": {
      "enabled": true,
      "host": "my-app.example.com",
      "tls": true
    }
  }
}
```

### 3.2 服务配置 / Service Configuration

**定义 3.2.1** (Kubernetes服务) Kubernetes服务配置：

```yaml
# service.yaml
apiVersion: v1
kind: Service
metadata:
  name: my-lean-app-service
  labels:
    app: my-lean-app
spec:
  selector:
    app: my-lean-app
  ports:
  - protocol: TCP
    port: 80
    targetPort: 8080
  type: ClusterIP
```

**定义 3.2.2** (Ingress配置) Ingress配置：

```yaml
# ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: my-lean-app-ingress
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  tls:
  - hosts:
    - my-app.example.com
    secretName: my-app-tls
  rules:
  - host: my-app.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: my-lean-app-service
            port:
              number: 80
```

## 4. CI/CD集成 / CI/CD Integration

### 4.1 GitHub Actions / GitHub Actions

**定义 4.1.1** (GitHub Actions) CI/CD流水线配置：

```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Lean
      uses: leanprover-community/setup-lean@v1
      with:
        lean-version: '4.0.0'
    
    - name: Install dependencies
      run: lake update
    
    - name: Run tests
      run: lake test
    
    - name: Build
      run: lake build

  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Lean
      uses: leanprover-community/setup-lean@v1
      with:
        lean-version: '4.0.0'
    
    - name: Build Docker image
      run: docker build -t my-lean-app:${{ github.sha }} .
    
    - name: Push to registry
      run: |
        echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
        docker push my-lean-app:${{ github.sha }}
    
    - name: Deploy to Kubernetes
      run: |
        kubectl set image deployment/my-lean-app my-lean-app=my-lean-app:${{ github.sha }}
        kubectl rollout status deployment/my-lean-app
```

### 4.2 GitLab CI / GitLab CI

**定义 4.2.1** (GitLab CI) GitLab CI/CD配置：

```yaml
# .gitlab-ci.yml
stages:
  - test
  - build
  - deploy

variables:
  DOCKER_IMAGE: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA

test:
  stage: test
  image: leanprover/lean4:latest
  script:
    - lake update
    - lake test
    - lake build
  only:
    - merge_requests
    - main

build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker build -t $DOCKER_IMAGE .
    - docker push $DOCKER_IMAGE
  only:
    - main

deploy:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - kubectl set image deployment/my-lean-app my-lean-app=$DOCKER_IMAGE
    - kubectl rollout status deployment/my-lean-app
  only:
    - main
  when: manual
```

## 5. 环境管理 / Environment Management

### 5.1 环境配置 / Environment Configuration

**定义 5.1.1** (环境配置) 多环境配置管理：

```json
{
  "environments": {
    "development": {
      "leanPath": "/usr/local/bin/lean",
      "lakePath": "/usr/local/bin/lake",
      "debug": true,
      "logLevel": "debug",
      "database": {
        "host": "localhost",
        "port": 5432,
        "name": "myapp_dev"
      }
    },
    "staging": {
      "leanPath": "/usr/local/bin/lean",
      "lakePath": "/usr/local/bin/lake",
      "debug": false,
      "logLevel": "info",
      "database": {
        "host": "staging-db.example.com",
        "port": 5432,
        "name": "myapp_staging"
      }
    },
    "production": {
      "leanPath": "/usr/local/bin/lean",
      "lakePath": "/usr/local/bin/lake",
      "debug": false,
      "logLevel": "warn",
      "database": {
        "host": "prod-db.example.com",
        "port": 5432,
        "name": "myapp_prod"
      }
    }
  }
}
```

### 5.2 配置管理 / Configuration Management

**定义 5.2.1** (配置管理) 配置管理策略：

```lean
-- 配置管理示例
structure AppConfig where
  environment : String
  debug : Bool
  logLevel : String
  database : DatabaseConfig
  api : ApiConfig

structure DatabaseConfig where
  host : String
  port : Nat
  name : String
  username : String
  password : String

structure ApiConfig where
  baseUrl : String
  timeout : Nat
  retries : Nat

-- 配置加载
def loadConfig (env : String) : IO AppConfig := do
  let configFile := s!"config/{env}.json"
  let configJson ← IO.FS.readFile configFile
  let config : AppConfig ← IO.ofExcept (Json.parse configJson >>= fromJson)
  pure config
```

## 6. 监控和日志 / Monitoring and Logging

### 6.1 监控配置 / Monitoring Configuration

**定义 6.1.1** (监控配置) 应用监控配置：

```json
{
  "monitoring": {
    "metrics": {
      "enabled": true,
      "port": 9090,
      "path": "/metrics",
      "interval": 30
    },
    "health": {
      "enabled": true,
      "port": 8080,
      "path": "/health",
      "checks": [
        "database",
        "external-api",
        "memory"
      ]
    },
    "alerts": {
      "enabled": true,
      "rules": [
        {
          "name": "high-cpu-usage",
          "condition": "cpu_usage > 80",
          "duration": "5m",
          "severity": "warning"
        },
        {
          "name": "high-memory-usage",
          "condition": "memory_usage > 90",
          "duration": "2m",
          "severity": "critical"
        }
      ]
    }
  }
}
```

### 6.2 日志配置 / Logging Configuration

**定义 6.2.1** (日志配置) 应用日志配置：

```json
{
  "logging": {
    "level": "info",
    "format": "json",
    "outputs": [
      {
        "type": "console",
        "enabled": true
      },
      {
        "type": "file",
        "enabled": true,
        "path": "/var/log/my-app.log",
        "maxSize": "100MB",
        "maxFiles": 5
      },
      {
        "type": "syslog",
        "enabled": true,
        "host": "localhost",
        "port": 514
      }
    ],
    "fields": {
      "service": "my-lean-app",
      "version": "1.0.0",
      "environment": "production"
    }
  }
}
```

## 7. 安全配置 / Security Configuration

### 7.1 安全策略 / Security Policies

**定义 7.1.1** (安全配置) 应用安全配置：

```json
{
  "security": {
    "authentication": {
      "enabled": true,
      "type": "jwt",
      "secret": "${JWT_SECRET}",
      "expiration": "24h"
    },
    "authorization": {
      "enabled": true,
      "rbac": true,
      "policies": [
        {
          "resource": "users",
          "actions": ["read", "write"],
          "roles": ["admin", "user"]
        }
      ]
    },
    "encryption": {
      "enabled": true,
      "algorithm": "AES-256-GCM",
      "key": "${ENCRYPTION_KEY}"
    },
    "cors": {
      "enabled": true,
      "origins": ["https://my-app.example.com"],
      "methods": ["GET", "POST", "PUT", "DELETE"],
      "headers": ["Content-Type", "Authorization"]
    }
  }
}
```

### 7.2 网络安全 / Network Security

**定义 7.2.1** (网络安全) 网络安全配置：

```yaml
# network-policy.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: my-lean-app-network-policy
spec:
  podSelector:
    matchLabels:
      app: my-lean-app
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 8080
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: database
    ports:
    - protocol: TCP
      port: 5432
```

## 8. 备份和恢复 / Backup and Recovery

### 8.1 备份策略 / Backup Strategy

**定义 8.1.1** (备份配置) 数据备份配置：

```json
{
  "backup": {
    "enabled": true,
    "schedule": "0 2 * * *",
    "retention": "30d",
    "storage": {
      "type": "s3",
      "bucket": "my-app-backups",
      "region": "us-west-2"
    },
    "databases": [
      {
        "name": "myapp_prod",
        "type": "postgresql",
        "schedule": "0 2 * * *"
      }
    ],
    "files": [
      {
        "path": "/var/lib/my-app/data",
        "schedule": "0 3 * * *"
      }
    ]
  }
}
```

### 8.2 恢复策略 / Recovery Strategy

**定义 8.2.1** (恢复配置) 数据恢复配置：

```bash
#!/bin/bash
# restore.sh - 数据恢复脚本

set -e

BACKUP_DATE=$1
if [ -z "$BACKUP_DATE" ]; then
  echo "Usage: $0 <backup-date>"
  exit 1
fi

echo "Restoring backup from $BACKUP_DATE..."

# 恢复数据库
echo "Restoring database..."
pg_restore -h localhost -U postgres -d myapp_prod /backups/db_$BACKUP_DATE.dump

# 恢复文件
echo "Restoring files..."
tar -xzf /backups/files_$BACKUP_DATE.tar.gz -C /

echo "Restore completed successfully!"
```

## 9. 性能优化 / Performance Optimization

### 9.1 性能配置 / Performance Configuration

**定义 9.1.1** (性能配置) 应用性能配置：

```json
{
  "performance": {
    "cache": {
      "enabled": true,
      "type": "redis",
      "host": "redis.example.com",
      "port": 6379,
      "ttl": 3600
    },
    "compression": {
      "enabled": true,
      "algorithm": "gzip",
      "level": 6
    },
    "connectionPool": {
      "enabled": true,
      "maxConnections": 100,
      "minConnections": 10,
      "idleTimeout": 300
    },
    "rateLimiting": {
      "enabled": true,
      "requestsPerMinute": 1000,
      "burstSize": 100
    }
  }
}
```

### 9.2 扩展配置 / Scaling Configuration

**定义 9.2.1** (扩展配置) 应用扩展配置：

```yaml
# hpa.yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: my-lean-app-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: my-lean-app
  minReplicas: 1
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

## 10. 故障排除 / Troubleshooting

### 10.1 部署问题 / Deployment Issues

**问题 10.1.1** (部署问题) 部署常见问题：

```bash
# 检查部署状态
kubectl get deployments
kubectl describe deployment my-lean-app

# 检查Pod状态
kubectl get pods
kubectl describe pod <pod-name>

# 检查日志
kubectl logs <pod-name>
kubectl logs -f <pod-name>

# 检查服务状态
kubectl get services
kubectl describe service my-lean-app-service
```

**解决方案 10.1.1** (问题解决) 部署问题解决方案：

1. **镜像问题**：检查镜像构建和推送
2. **配置问题**：验证配置文件和环境变量
3. **资源问题**：检查资源限制和请求
4. **网络问题**：检查网络策略和服务配置

### 10.2 性能问题 / Performance Issues

**问题 10.2.1** (性能问题) 性能问题诊断：

```bash
# 检查资源使用
kubectl top pods
kubectl top nodes

# 检查事件
kubectl get events --sort-by=.metadata.creationTimestamp

# 性能分析
kubectl exec <pod-name> -- lean --profile Main.lean

# 内存分析
kubectl exec <pod-name> -- lean --memory-profile Main.lean
```

## 11. 总结与展望 / Summary and Outlook

### 11.1 核心贡献 / Core Contributions

1. **完整部署**：提供了完整的部署解决方案
2. **容器化支持**：支持Docker和Kubernetes部署
3. **CI/CD集成**：建立了自动化部署流水线
4. **监控管理**：提供了完整的监控和日志系统

### 11.2 未来方向 / Future Directions

1. **功能扩展**：继续扩展部署功能
2. **性能优化**：进一步优化部署性能
3. **安全增强**：增强安全配置和管理
4. **自动化改进**：改善自动化部署体验

---

## 交叉引用 / Cross-References

- **上一节**：[5.6 测试工具](5.6-测试工具.md)
- **下一节**：[返回目录](README.md)
- **上位主题**：[5. 工具集成指南](README.md)
- **下位细分主题**：
  - [5.7.1 容器化部署详解](5.7.1-容器化部署详解.md)
  - [5.7.2 Kubernetes部署详解](5.7.2-Kubernetes部署详解.md)
  - [5.7.3 CI/CD集成详解](5.7.3-CI-CD集成详解.md)

## 参考资料 / References

1. **官方文档**：
   - [Docker 官方文档](https://docs.docker.com/)
   - [Kubernetes 官方文档](https://kubernetes.io/docs/)

2. **技术文档**：
   - [GitHub Actions](https://docs.github.com/en/actions)
   - [GitLab CI/CD](https://docs.gitlab.com/ee/ci/)

3. **社区资源**：
   - [Lean 社区论坛](https://leanprover-community.github.io/)
   - [部署最佳实践](https://leanprover-community.github.io/learn.html)

---

## 变更记录 / Change Log

### v2025-01-01

- 初始版本创建
- 添加部署基础配置和构建配置
- 建立容器化部署和Kubernetes支持
- 添加CI/CD集成和环境管理
- 建立监控、安全和性能优化体系

---

*最后更新：2025-01-01*  
*版本：v2025-01*  
*状态：已完成 ✅*
